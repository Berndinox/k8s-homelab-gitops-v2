---
# Installs reference CNI plugins missing from Talos Linux
# (vlan, ipvlan, macvlan, static â€” needed for Multus NADs)
# This is the Talos-recommended approach: CNI plugins are static binaries
# installed via DaemonSet to /opt/cni/bin (writable on Talos).
apiVersion: apps/v1
kind: DaemonSet
metadata:
  name: cni-plugins-installer
  namespace: kube-system
  labels:
    app: cni-plugins-installer
spec:
  selector:
    matchLabels:
      app: cni-plugins-installer
  template:
    metadata:
      labels:
        app: cni-plugins-installer
    spec:
      hostNetwork: true
      initContainers:
        - name: install
          image: alpine:3.21
          command:
            - sh
            - -c
            - |
              set -e
              if [ -f /host/opt/cni/bin/vlan ] && [ -f /host/opt/cni/bin/ipvlan ]; then
                echo "CNI plugins already installed, skipping"
                exit 0
              fi
              apk add --no-cache curl
              ARCH=$(uname -m | sed 's/x86_64/amd64/' | sed 's/aarch64/arm64/')
              VERSION="v1.6.2"
              URL="https://github.com/containernetworking/plugins/releases/download/${VERSION}/cni-plugins-linux-${ARCH}-${VERSION}.tgz"
              echo "Downloading CNI plugins from ${URL}"
              curl -sL "$URL" | tar xz -C /host/opt/cni/bin/ ./vlan ./ipvlan ./macvlan ./static
              echo "Installed: vlan ipvlan macvlan static"
          volumeMounts:
            - name: cni-bin
              mountPath: /host/opt/cni/bin
      containers:
        - name: pause
          image: registry.k8s.io/pause:3.10
          resources:
            requests:
              cpu: 1m
              memory: 4Mi
            limits:
              memory: 8Mi
      volumes:
        - name: cni-bin
          hostPath:
            path: /opt/cni/bin
