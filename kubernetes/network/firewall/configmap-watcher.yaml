---
apiVersion: v1
kind: ConfigMap
metadata:
  name: firewall-watcher
  namespace: network
data:
  config-watcher.sh: |
    #!/bin/bash
    CONFIG_SOURCE="/opt/gitops-config/router.conf"
    CONFIG_RENDERED="/run/router-rendered.conf"
    SECRETS_DIR="/opt/gitops-secrets"
    APPLY_SCRIPT="/opt/gitops-scripts/apply-config.sh"
    HASH_FILE="/run/config-watcher.hash"
    POLL_INTERVAL=10
    BOOT_TIMEOUT=300

    log() { echo "$(date '+%Y-%m-%d %H:%M:%S') [config-watcher] $1"; }

    wait_for_boot() {
        log "Waiting for router boot ..."
        local elapsed=0
        while [ $elapsed -lt $BOOT_TIMEOUT ]; do
            if systemctl is-active --quiet vyos-router.service; then
                sleep 15
                log "Router boot complete."
                return 0
            fi
            sleep 5
            elapsed=$((elapsed + 5))
        done
        log "ERROR: Boot timeout after ${BOOT_TIMEOUT}s"
        return 1
    }

    wait_for_boot || exit 1

    log "Watching $CONFIG_SOURCE (every ${POLL_INTERVAL}s)"

    render_config() {
        local src="$1" dst="$2"
        cp "$src" "$dst"
        if [ -f "${SECRETS_DIR}/vyos-password-hash" ]; then
            local hash
            hash=$(cat "${SECRETS_DIR}/vyos-password-hash")
            sed -i "s|__VYOS_PASSWORD_HASH__|${hash}|g" "$dst"
        fi
    }

    while true; do
        [ -f "$CONFIG_SOURCE" ] || { sleep "$POLL_INTERVAL"; continue; }

        render_config "$CONFIG_SOURCE" "$CONFIG_RENDERED"
        current_hash=$(md5sum "$CONFIG_RENDERED" 2>/dev/null | cut -d' ' -f1)
        last_hash=$(cat "$HASH_FILE" 2>/dev/null || echo "")

        if [ "$current_hash" != "$last_hash" ]; then
            log "Change detected (${last_hash:0:8} -> ${current_hash:0:8})"

            if sg vyattacfg -c "/bin/vbash $APPLY_SCRIPT" 2>&1 | tee -a /var/log/config-watcher.log; then
                echo "$current_hash" > "$HASH_FILE"
                log "Config applied successfully"
            else
                log "Apply failed (exit $?), retry next cycle"
                rm -f /opt/vyatta/config/.lock 2>/dev/null
            fi
        fi

        sleep "$POLL_INTERVAL"
    done
  apply-config.sh: |
    #!/bin/vbash
    source /opt/vyatta/etc/functions/script-template

    CONFIG_FILE="/run/router-rendered.conf"
    if [ ! -f "$CONFIG_FILE" ]; then
        echo "ERROR: Config file not found: $CONFIG_FILE"
        exit 1
    fi

    configure

    if ! load "$CONFIG_FILE"; then
        echo "ERROR: load failed"
        exit discard
        exit 1
    fi

    if ! compare >/dev/null 2>&1; then
        echo "Config identical, no changes needed."
        exit discard
        exit 0
    fi

    echo "Changes to apply:"
    compare

    if commit; then
        echo "Commit OK"
        save
        exit
    else
        echo "ERROR: commit failed"
        exit discard
        exit 1
    fi
