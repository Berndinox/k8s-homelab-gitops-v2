---
apiVersion: v1
kind: ConfigMap
metadata:
  name: vyos-config
  namespace: network
data:
  # Native VyOS config format — delta-applied by watcher on change
  vyos.conf: |
    system {
        host-name vyos-k8s
        name-server 1.1.1.1
        name-server 8.8.8.8
        syslog {
            global {
                facility all {
                    level info
                }
            }
        }
    }
  # Watcher script — polls for ConfigMap changes and delta-applies
  config-watcher.sh: |
    #!/bin/vbash
    source /opt/vyatta/etc/functions/script-template

    CONFIG_SOURCE="/config/vyos-gitops/vyos.conf"
    HASH_FILE="/run/vyos-config-watcher.hash"
    LOCK_FILE="/opt/vyatta/config/.lock"
    POLL_INTERVAL=10
    BOOT_TIMEOUT=300

    if [ "$(id -g -n)" != 'vyattacfg' ]; then
        exec sg vyattacfg -c "/bin/vbash $(readlink -f $0) $@"
    fi

    log() { echo "$(date '+%Y-%m-%d %H:%M:%S') [config-watcher] $1"; }

    wait_for_boot() {
        log "Waiting for vyos-router.service ..."
        local elapsed=0
        while [ $elapsed -lt $BOOT_TIMEOUT ]; do
            if systemctl is-active --quiet vyos-router.service; then
                log "VyOS boot complete."
                return 0
            fi
            sleep 5
            elapsed=$((elapsed + 5))
        done
        log "ERROR: Boot timeout after ${BOOT_TIMEOUT}s"
        return 1
    }

    is_locked() {
        [ -f "$LOCK_FILE" ]
    }

    apply_config() {
        local config_file="$1"

        if [ ! -f "$config_file" ]; then
            log "ERROR: Config file not found: $config_file"
            return 1
        fi

        local lock_wait=0
        while is_locked && [ $lock_wait -lt 60 ]; do
            log "Config locked, waiting..."
            sleep 5
            lock_wait=$((lock_wait + 5))
        done
        if is_locked; then
            log "ERROR: Config lock held >60s, skipping"
            return 1
        fi

        log "Loading config from $config_file"
        configure

        if ! load "$config_file"; then
            log "ERROR: load failed"
            exit discard
            return 1
        fi

        if ! compare >/dev/null 2>&1; then
            log "Config identical, no changes."
            exit discard
            return 0
        fi

        log "Changes detected:"
        compare
        log "Committing delta..."

        if commit; then
            log "Commit OK"
            save
            exit
            return 0
        else
            log "ERROR: commit failed, discarding"
            exit discard
            return 1
        fi
    }

    main() {
        wait_for_boot || return 1
        sleep 5

        log "Watching $CONFIG_SOURCE (every ${POLL_INTERVAL}s)"

        if [ -f "$CONFIG_SOURCE" ]; then
            if apply_config "$CONFIG_SOURCE"; then
                md5sum "$CONFIG_SOURCE" 2>/dev/null | cut -d' ' -f1 > "$HASH_FILE"
            fi
        else
            log "No config at $CONFIG_SOURCE yet, waiting..."
        fi

        while true; do
            sleep "$POLL_INTERVAL"
            [ -f "$CONFIG_SOURCE" ] || continue

            local current_hash last_hash
            current_hash=$(md5sum "$CONFIG_SOURCE" 2>/dev/null | cut -d' ' -f1)
            last_hash=$(cat "$HASH_FILE" 2>/dev/null || echo "")

            if [ "$current_hash" != "$last_hash" ]; then
                log "Change detected (${last_hash:0:8} -> ${current_hash:0:8})"
                if apply_config "$CONFIG_SOURCE"; then
                    echo "$current_hash" > "$HASH_FILE"
                else
                    log "Apply failed, retry next cycle"
                fi
            fi
        done
    }

    main "$@"
