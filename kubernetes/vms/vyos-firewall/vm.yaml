---
# VyOS-01 Firewall VM
#
# Image: ghcr.io/berndinox/vyos-image-builder:2026.02 (ContainerDisk, ephemer)
#   → cloud-init läuft bei jedem Boot → 100% GitOps, kein Drift möglich
#   → Image-Update: Tag in containerDisk ändern + commit
#
# Interface-Mapping:
#   eth0  masquerade   Pod-Netz (K8s intern)
#   eth1  VLAN 5       WAN      (Public IP per DHCP)
#   eth2  VLAN 10      DMZ      10.0.10.190/24
#   eth3  VLAN 30      WiFi-Guest 10.0.30.190/24
#   eth4  VLAN 40      Client   10.0.40.190/24
#   eth5  VLAN 50      Server   10.0.50.190/24
#   eth6  VLAN 60      WiFi-Secure 10.0.60.190/24
#   eth7  VLAN 100     Cluster  10.0.100.190/24
#   eth8  VLAN 200     MGMT     10.0.200.190/24
#
# HA-Vorbereitung:
#   VyOS-01 = .190, VyOS-02 = .191, VRRP-VIP = .1
#   Für VyOS-02: diese Datei kopieren → vm-02.yaml,
#   name → 'vyos-fw-02', cloud-init Secret → 'vyos-cloudinit-02'
#
# VM starten (nach SSH-Key in cloudinit.yaml + ghcr-pull-secret gesetzt):
#   kubectl patch vm vyos-fw-01 -n vms --type=merge -p '{"spec":{"running":true}}'
# Konsole:
#   virtctl console vyos-fw-01 -n vms
# SSH:
#   virtctl ssh vyos@vyos-fw-01 -n vms
#
apiVersion: kubevirt.io/v1
kind: VirtualMachine
metadata:
  name: vyos-fw-01
  namespace: vms
  labels:
    app: vyos-firewall
    instance: vyos-fw-01
    role: firewall
spec:
  # runStrategy: Halted — erst starten wenn:
  #   1. SSH-Key in cloudinit.yaml eingetragen + committed
  #   2. ghcr-pull-secret im vms-Namespace vorhanden (SOPS decrypt)
  #   3. ContainerDisk Image in GHCR gebaut (GH Actions workflow_dispatch)
  # VM starten: kubectl patch vm vyos-fw-01 -n vms --type=merge -p '{"spec":{"runStrategy":"Always"}}'
  runStrategy: Halted

  template:
    metadata:
      labels:
        app: vyos-firewall
        instance: vyos-fw-01
        role: firewall
      annotations:
        # Multus — 8 VLAN-Interfaces, Reihenfolge = eth1–eth8 im Gast
        k8s.v1.cni.cncf.io/networks: |
          [
            {"name": "vlan-5-wan",       "namespace": "default", "interface": "eth1"},
            {"name": "vlan-10-dmz",      "namespace": "default", "interface": "eth2"},
            {"name": "vlan-30-wifi",     "namespace": "default", "interface": "eth3"},
            {"name": "vlan-40-client",   "namespace": "default", "interface": "eth4"},
            {"name": "vlan-50-server",   "namespace": "default", "interface": "eth5"},
            {"name": "vlan-60-wifi-sec", "namespace": "default", "interface": "eth6"},
            {"name": "vlan-100-cluster", "namespace": "default", "interface": "eth7"},
            {"name": "vlan-200-mgmt",    "namespace": "default", "interface": "eth8"}
          ]
    spec:
      domain:
        # --- CPU ---
        cpu:
          cores: 2
          sockets: 1
          threads: 1
        # --- RAM ---
        memory:
          guest: 1Gi
        # --- Machine ---
        machine:
          type: q35

        # --- Devices ---
        devices:
          disks:
            - name: boot
              disk:
                bus: virtio
              bootOrder: 1
            - name: cloudinit
              disk:
                bus: virtio
          interfaces:
            # eth0: Pod-Netz (masquerade)
            - name: default
              masquerade: {}
              model: virtio
            # eth1–eth8: VLAN-Interfaces via Multus (bridge = L2 direkt)
            - name: wan
              bridge: {}
              model: virtio
            - name: dmz
              bridge: {}
              model: virtio
            - name: wifi-guest
              bridge: {}
              model: virtio
            - name: client
              bridge: {}
              model: virtio
            - name: server
              bridge: {}
              model: virtio
            - name: wifi-sec
              bridge: {}
              model: virtio
            - name: cluster
              bridge: {}
              model: virtio
            - name: mgmt
              bridge: {}
              model: virtio
          autoattachSerialConsole: true
          autoattachGraphicsDevice: false

      # --- Volumes ---
      volumes:
        - name: boot
          containerDisk:
            image: ghcr.io/berndinox/vyos-image-builder:2026.02
            imagePullPolicy: IfNotPresent
            # imagePullSecret ist ein Feld in containerDisk (KubeVirt-spezifisch, nicht K8s-Standard)
            imagePullSecret: ghcr-pull-secret
        - name: cloudinit
          cloudInitNoCloud:
            # secretRef (nicht userDataSecretRef) — KubeVirt-CRD v1.7.0 Feldname
            secretRef:
              name: vyos-cloudinit

      # --- Netzwerke ---
      networks:
        - name: default
          pod: {}
        - name: wan
          multus:
            networkName: default/vlan-5-wan
        - name: dmz
          multus:
            networkName: default/vlan-10-dmz
        - name: wifi-guest
          multus:
            networkName: default/vlan-30-wifi
        - name: client
          multus:
            networkName: default/vlan-40-client
        - name: server
          multus:
            networkName: default/vlan-50-server
        - name: wifi-sec
          multus:
            networkName: default/vlan-60-wifi-sec
        - name: cluster
          multus:
            networkName: default/vlan-100-cluster
        - name: mgmt
          multus:
            networkName: default/vlan-200-mgmt

      terminationGracePeriodSeconds: 30
      nodeSelector:
        kubernetes.io/os: linux
