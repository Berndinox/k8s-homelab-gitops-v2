# Architecture Review — 2026-02-28

> Reviewer: Claude (IT Architect / Security Review)
> Scope: Gesamtlösung k8s-homelab-gitops-v2

---

## Teil 1: Cluster (Talos)

### CRITICAL

| # | Finding | Datei | Empfehlung |
|---|---------|-------|------------|
| C1 | ~~`talsecret.yaml` in Git-History~~ | cluster/talsecret.yaml | **ERLEDIGT** — war nie in History, .gitignore hat gegriffen |
| C2 | ArgoCD `server.insecure=true` im Bootstrap | scripts/bootstrap.sh:142 | Vorerst belassen — Wechsel zu FluxCD wird evaluiert |

### IMPORTANT

| # | Finding | Datei | Empfehlung |
|---|---------|-------|------------|
| I1 | ~~Cilium-Version Diskrepanz~~ | COMMANDS.md:242 | **ERLEDIGT** — COMMANDS.md auf 1.19.1 + ArgoCD auf 9.4.4 aktualisiert |
| I2 | Kein etcd-Backup konfiguriert | — | Talos etcd-Snapshot-CronJob oder externes Backup einrichten |
| I3 | Keine NetworkPolicies definiert | — | Zero-Trust: Default-Deny + Allow-Specific pro Namespace |
| I4 | Monitoring/Alerting fehlt komplett | — | Prometheus + Grafana deployen (Cilium Hubble + Longhorn Metrics) |
| I5 | Longhorn-Disk auf Node 01+02 noch nicht provisioniert | COMMANDS.md:282 | nvme0n1 wipen bei Node-Join (Doku vorhanden) |
| I6 | Single DNS-Server (9.9.9.9) in common.yaml | patches/common.yaml | Zweiten DNS hinzufügen (z.B. 1.1.1.1) |

### MINOR

| # | Finding | Datei | Empfehlung |
|---|---------|-------|------------|
| M1 | bootstrap.sh nicht idempotent | scripts/bootstrap.sh | Helm `upgrade --install` ist OK, aber kubectl apply für root-app prüfen |
| M2 | kubeconfig zeigt auf VIP 10.0.100.10, manuelles sed nötig | COMMANDS.md:154 | Auto-Detect im bootstrap.sh einbauen |
| M3 | Talos-Upgrade-Strategie nicht dokumentiert | — | Rollout-Prozedur dokumentieren |

### POSITIV

- Bond0 mit LACP (802.3ad) + fast LACP Rate — korrekt für 10G Trunk
- VIP auf allen 3 Nodes für HA API-Server
- Schematic mit intel-ucode, iscsi-tools, util-linux-tools — sinnvolle Extensions
- `allowSchedulingOnControlPlanes: true` — richtig für 3-Node all-in-one
- CNI: `name: none` + Proxy: `disabled: true` — korrekt für Cilium
- NTP: Cloudflare + pool.ntp.org — gute Diversität
- Longhorn-Disk-Selector mit Größenfilter — smart

---

## Teil 2: Kubernetes (GitOps)

### CRITICAL

| # | Finding | Datei | Empfehlung |
|---|---------|-------|------------|
| C3 | ~~VyOS Passwort-Hash in ConfigMap~~ | network/firewall/configmap.yaml:78 | **ERLEDIGT** — SealedSecret + Platzhalter-Rendering via Config-Watcher |
| C4 | Firewall `privileged: true` ohne Capability-Einschränkung | network/firewall/deployment.yaml:38 | Spezifische Capabilities (NET_ADMIN, NET_RAW, SYS_ADMIN) statt full privileged |

### IMPORTANT

| # | Finding | Datei | Empfehlung |
|---|---------|-------|------------|
| I7 | Keine Health Probes auf Firewall-Pod | network/firewall/deployment.yaml | startupProbe + livenessProbe hinzufügen |
| I8 | Router-Image nur Tag-pinned (:2026.02) | network/firewall/deployment.yaml:35 | Image-Digest pinnen (@sha256:...) |
| I9 | Config-Watcher ohne Rollback bei fehlerhafter Config | network/firewall/configmap-watcher.yaml | Dry-Run vor Commit, Rollback-Mechanismus |
| I10 | BGPv2 nicht implementiert (Placeholder) | core/cilium-bgp/ | BGPv2 CRDs erstellen wenn Router aktiv |
| I11 | Alle Apps in `project: default` | alle application.yaml | ArgoCD Projects für RBAC-Trennung |
| I12 | Replicas=1 überall (Single Point of Failure) | diverse | Auf 3 hochskalieren nach Node-Join |
| I13 | Multus lädt Manifest von externem GitHub-URL | core/multus/manifests/kustomization.yaml:5 | Lokal spiegeln oder auf Commit-SHA pinnen |

### MINOR

| # | Finding | Datei | Empfehlung |
|---|---------|-------|------------|
| M4 | KubeVirt deployed aber User will es nicht | core/kustomization.yaml | KubeVirt + CDI entfernen (User-Präferenz: kein KubeVirt) |
| M5 | Doppelte ClusterIssuer-Definition | infra/cert-manager/clusterissuer.yaml | Löschen — wird bereits via extraObjects im Helm-Chart erstellt |
| M6 | install-cni Image nicht Digest-pinned | core/multus/manifests/install-cni-patch.yaml:17 | @sha256:... anhängen |
| M7 | Cilium ignoreDifferences für Hubble-Secrets | core/cilium/application.yaml:125 | Dokumentieren im Runbook |
| M8 | LB-Pool CIDR hat "REPLACE"-Kommentar | core/cilium-bgp/lb-pool-server.yaml:14 | Aufräumen, finale Werte setzen |
| M9 | Keine PodDisruptionBudgets | — | PDBs für Cilium, Longhorn, Firewall |

### POSITIV

- ArgoCD Sync-Wave-Ordering sauber durchdacht (-3 bis +1)
- Cilium mit `cni.exclusive: false` für Multus-Koexistenz
- Kustomize-Patches statt Fork (Multus install-cni) — wartbar
- Longhorn CRD-Protection via `ServerSideApply` + `Replace=true`
- cert-manager mit selbstsignierter CA (homelab-ca) — pragmatisch
- Config-Watcher-Pattern für VyOS — clever gelöst
- NADs mit korrekten statischen IPs und VLAN-Trennung

---

## Risiko-Matrix

| Bereich | Risiko | Priorität |
|---------|--------|-----------|
| Secrets Management | HOCH | Sofort |
| Firewall Security Context | HOCH | Sofort |
| ArgoCD TLS | MITTEL | Diese Woche |
| Health Probes | MITTEL | Diese Woche |
| Monitoring | MITTEL | Nächste 2 Wochen |
| BGP Completion | NIEDRIG | Nach Router-Setup |
| HA/Replicas | NIEDRIG | Nach Node-Join |

---

## Quick Wins (< 30 Min Aufwand)

1. COMMANDS.md Cilium-Version auf 1.19.1 aktualisieren
2. Doppelte clusterissuer.yaml löschen
3. KubeVirt + CDI entfernen (wenn nicht gewünscht)
4. LB-Pool "REPLACE"-Kommentare aufräumen
5. Health Probes zum Firewall-Deployment hinzufügen
6. ArgoCD `server.insecure` entfernen (TLS via cert-manager)

## Mittelfristig (Nächster Sprint)

7. VyOS-Passwort in Secret verschieben
8. Firewall Capabilities statt `privileged: true`
9. Image-Digests pinnen (Router, install-cni)
10. NetworkPolicies für alle Namespaces
11. Prometheus + Grafana Stack deployen
12. etcd-Backup einrichten
13. Config-Watcher Rollback-Mechanismus

## Langfristig

14. ArgoCD Projects + RBAC
15. BGPv2 Implementierung
16. HA (3 Replicas) nach Node-Join
17. Disaster Recovery Runbook
18. Talos Auto-Update-Strategie
